<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>统一搜索系统</title>
<style>
    body {
        background: url('backGround.png') no-repeat center center fixed;
        background-size: cover;
        margin: 0;
        font-family: Arial, sans-serif;
        color: #333;
    }

    .wrapper {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
        position: relative;
    }

    h1 {
        color: peachpuff;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        margin: 40px 0;
        font-weight: bold;
        /* 炫酷文字特效 */
        text-shadow: 0 0 10px rgba(0,102,204,0.7), 0 0 20px rgba(0,102,204,0.4);
        transition: transform 0.3s ease, text-shadow 0.3s ease;
    }

    h1:hover {
        text-shadow: 0 0 15px rgba(0,102,204,0.9), 0 0 30px rgba(0,102,204,0.6);
        transform: scale(1.05);
    }

    h1 img {
        vertical-align: middle;
        width: 60px;
        height: 60px;
        margin-right: 20px;
        transition: transform 0.3s ease;
    }

    h1 img:hover {
        transform: rotate(10deg) scale(1.1);
    }

    .content-layer {
        background-color: rgba(255,255,255,0.85);
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        padding: 30px;
        position: relative;
    }

    .search-container {
        margin-bottom: 30px;
        position: relative;
    }

    .search-mode {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

    .search-mode-btn {
        padding: 10px 20px;
        margin: 0 10px;
        background-color: #f0f0f0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.3s ease;
        font-size: 16px;
        font-weight: bold;
    }

    .search-mode-btn.active {
        background-color: #0066cc;
        color: white;
        box-shadow: 0 0 10px rgba(0,102,204,0.5);
    }

    .search-mode-btn:hover {
        background-color: #005ab3;
        color: #fff;
        box-shadow: 0 0 8px rgba(0,102,204,0.5);
    }

    .search-form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
        flex-wrap: wrap;
        position: relative;
    }

    .search-form input, .search-form select {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        flex: 1 1 auto;
        min-width: 200px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .search-form input:focus, .search-form select:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 8px rgba(0,102,204,0.3);
    }

    .search-form button {
        padding: 10px 15px;
        background-color: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.3s;
        font-size: 16px;
        font-weight: bold;
    }

    .search-form button:hover {
        background-color: #005ab3;
        box-shadow: 0 0 8px rgba(0,102,204,0.5);
    }

    #docTypeContainer {
        display: none;
    }

    .results {
        margin-top: 20px;
    }

    .result-item {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: box-shadow 0.3s ease;
    }

    .result-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .result-item h3 {
        margin-top: 0;
        color: #0066cc;
        font-size: 18px;
    }

    .result-item .snippet {
        color: #666;
        margin-top: 10px;
        font-size: 14px;
    }

    .result-metadata {
        font-size: 14px;
        color: #888;
        margin-top: 10px;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
    }

    .pagination button, .pagination select {
        padding: 8px 12px;
        background-color: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.3s;
        font-size: 14px;
    }

    .pagination button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        box-shadow: none;
    }

    .pagination select {
        background-color: #fff;
        color: #333;
        border: 1px solid #ddd;
        padding: 6px;
        box-shadow: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .pagination select:hover {
        border-color: #0066cc;
        box-shadow: 0 0 6px rgba(0,102,204,0.3);
    }

    /* 历史记录下拉列表样式 */
    .history-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
    }

    .history-item {
        padding: 10px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .history-item:hover {
        background-color: #f5f5f5;
    }

    .history-item .history-text {
        flex-grow: 1;
        margin-right: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .history-item .delete-btn {
        background: none;
        border: none;
        color: #ff4d4d;
        cursor: pointer;
        font-size: 14px;
    }

    .history-item .delete-btn:hover {
        color: #ff1a1a;
    }
</style>
</head>
<body>
    <div class="wrapper">
        <h1><img src="mark.png" alt="Logo">统一搜索系统</h1>
        <div class="content-layer">
            <div class="search-container">
                <div class="search-mode">
                    <button id="normalSearchBtn" class="search-mode-btn active">普通搜索</button>
                    <button id="documentSearchBtn" class="search-mode-btn">文档搜索</button>
                </div>

                <form id="searchForm" class="search-form" autocomplete="off">
                    <div style="position: relative; width: 100%;">
                        <input type="text" id="searchInput" placeholder="输入搜索关键词..." required>
                        <div id="historyDropdown" class="history-dropdown"></div>
                    </div>
                    <div id="docTypeContainer">
                        <select id="docTypeSelect">
                            <option value="">选择文档类型</option>
                            <option value="doc">Word (.doc)</option>
                            <option value="docx">Word (.docx)</option>
                            <option value="pdf">PDF (.pdf)</option>
                            <option value="xls">Excel (.xls)</option>
                            <option value="xlsx">Excel (.xlsx)</option>
                        </select>
                    </div>

                    <select id="searchModeSelect">
                        <option value="normal">普通搜索</option>
                        <option value="wildcard">通配查询</option>
                        <option value="phrase">短语查询</option>
                    </select>

                    <button type="submit">搜索</button>
                </form>
            </div>

            <div id="resultsContainer" class="results"></div>

            <div id="paginationContainer" class="pagination" style="display:none;">
                <button id="prevPageBtn">上一页</button>
                <span id="pageInfo"></span>
                <select id="pageSelect"></select>
                <button id="nextPageBtn">下一页</button>
            </div>
        </div>
    </div>

    <script>
        const normalSearchBtn = document.getElementById('normalSearchBtn');
        const documentSearchBtn = document.getElementById('documentSearchBtn');
        const docTypeContainer = document.getElementById('docTypeContainer');
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const docTypeSelect = document.getElementById('docTypeSelect');
        const searchModeSelect = document.getElementById('searchModeSelect');
        const resultsContainer = document.getElementById('resultsContainer');
        const paginationContainer = document.getElementById('paginationContainer');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');
        const pageSelect = document.getElementById('pageSelect');
        const historyDropdown = document.getElementById('historyDropdown');

        let currentSearchMode = 'normal';
        let currentQuery = '';
        let currentPage = 1;
        let totalPages = 0;

        normalSearchBtn.addEventListener('click', () => {
            currentSearchMode = 'normal';
            normalSearchBtn.classList.add('active');
            documentSearchBtn.classList.remove('active');
            docTypeContainer.style.display = 'none';
            docTypeSelect.value = '';
        });

        documentSearchBtn.addEventListener('click', () => {
            currentSearchMode = 'document';
            documentSearchBtn.classList.add('active');
            normalSearchBtn.classList.remove('active');
            docTypeContainer.style.display = 'block';
        });

        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            currentQuery = searchInput.value.trim();
            if (currentQuery === '') return;
            currentPage = 1;
            performSearch();
            hideHistoryDropdown();
        });

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                performSearch();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                performSearch();
            }
        });

        pageSelect.addEventListener('change', () => {
            const selectedPage = parseInt(pageSelect.value, 10);
            if (!isNaN(selectedPage) && selectedPage >= 1 && selectedPage <= totalPages) {
                currentPage = selectedPage;
                performSearch();
            }
        });

        // 历史记录相关
        searchInput.addEventListener('focus', () => {
            fetchHistory();
        });

        searchInput.addEventListener('input', () => {
            fetchHistory();
        });

        document.addEventListener('click', (event) => {
            if (!searchForm.contains(event.target)) {
                hideHistoryDropdown();
            }
        });

        function fetchHistory() {
            fetch('http://localhost:5000/api/query_history')
                .then(response => response.json())
                .then(data => {
                    displayHistory(data);
                })
                .catch(error => {
                    console.error('获取历史记录出错:', error);
                });
        }

        function displayHistory(historyList) {
            historyDropdown.innerHTML = '';
            if (historyList.length === 0) {
                historyDropdown.style.display = 'none';
                return;
            }

            historyList.forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';

                const historyText = document.createElement('span');
                historyText.className = 'history-text';
                historyText.textContent = entry.query;

                historyText.addEventListener('click', () => {
                    searchInput.value = entry.query;
                    currentQuery = entry.query;
                    currentPage = 1;
                    performSearch();
                    hideHistoryDropdown();
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.title = '删除';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteHistoryEntry(entry.id);
                });

                historyItem.appendChild(historyText);
                historyItem.appendChild(deleteBtn);
                historyDropdown.appendChild(historyItem);
            });

            historyDropdown.style.display = 'block';
        }

        function hideHistoryDropdown() {
            historyDropdown.style.display = 'none';
        }

        function deleteHistoryEntry(id) {
            if (!confirm('确定要删除这条历史记录吗？')) return;
            fetch('http://localhost:5000/api/delete_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    fetchHistory();
                } else if (data.error) {
                    alert('删除失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('删除历史记录出错:', error);
            });
        }

        function performSearch() {
            const query = currentQuery;
            const url = new URL('http://localhost:5000/search');
            url.searchParams.set('query', query);
            url.searchParams.set('page', currentPage);
            const selectedSearchMode = searchModeSelect.value;

            if (selectedSearchMode === 'wildcard') {
                url.searchParams.set('wildcard', 'true');
                url.searchParams.set('phrase', 'false');
            } else if (selectedSearchMode === 'phrase') {
                url.searchParams.set('wildcard', 'false');
                url.searchParams.set('phrase', 'true');
            } else {
                url.searchParams.set('wildcard', 'false');
                url.searchParams.set('phrase', 'false');
            }

            if (currentSearchMode === 'document') {
                const docType = docTypeSelect.value;
                if (!docType) {
                    alert('请选择文档类型');
                    return;
                }
                url.searchParams.set('file_type', docType);
            }

            fetch(url.toString())
                .then(response => response.json())
                .then(data => {
                    displayResults(data);
                })
                .catch(error => {
                    console.error('搜索出错:', error);
                    resultsContainer.innerHTML = '<p>搜索出现错误，请稍后重试。</p>';
                });
        }

        function displayResults(data) {
            resultsContainer.innerHTML = '';
            if (!data.hits || data.hits.length === 0) {
                resultsContainer.innerHTML = '<p>没有找到匹配的结果。</p>';
                paginationContainer.style.display = 'none';
                return;
            }

            data.hits.forEach(hit => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                resultDiv.addEventListener('click', () => {
                    window.open(`detail.html?url=${encodeURIComponent(hit.url)}`, '_blank');
                });

                let titleHtml = `
                    <h3>
                        <a href="${hit.url}" target="_blank" onclick="event.stopPropagation();">${hit.title || '无标题'}</a>
                    </h3>
                `;
                let resultContent = `${titleHtml}
                    <p class="snippet">${hit.snippet}</p>
                `;

                if (currentSearchMode === 'document' && hit.attachments && hit.attachments.length > 0) {
                    const attachmentsList = hit.attachments.map(att =>
                        `<a href="${att.url}" target="_blank" onclick="event.stopPropagation();">${att.name} (${att.type})</a>`
                    ).join(', ');
                    resultContent += `<div class="result-metadata">相关文档: ${attachmentsList}</div>`;
                }

                resultContent += `
                    <div class="result-metadata">
                        ${hit.publisher ? `发布者: ${hit.publisher} | ` : ''}
                        ${hit.publish_time ? `发布时间: ${hit.publish_time} | ` : ''}
                        浏览量: ${hit.views || '未知'}
                    </div>
                `;

                resultDiv.innerHTML = resultContent;
                resultsContainer.appendChild(resultDiv);
            });

            totalPages = data.total_pages || 0;
            pageInfo.textContent = `第 ${data.page} 页，共 ${data.total_pages} 页（共 ${data.total} 条结果）`;

            paginationContainer.style.display = data.total > 0 ? 'flex' : 'none';

            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;

            pageSelect.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `第 ${i} 页`;
                if (i === data.page) {
                    option.selected = true;
                }
                pageSelect.appendChild(option);
            }
        }
    </script>
</body>
</html>
